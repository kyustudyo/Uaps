# 인수인계 문서 (2025-10-10)

## 📌 세션 요약

이번 세션에서는 **ThreePartRobotBuilder 자동화 툴**과 관련 문서화 작업을 완료했습니다.

---

## ✅ 완료된 작업

### 1. MarineThreeRobot 프리팹 수정 (선택/드래그 문제 해결)

**문제:**
- MarineThreeRobot이 선택되지 않고 드래그도 안됨
- DecalProjector Material이 null
- Layer가 0 (Default)
- 필수 필드들이 누락됨 (decalProjector, UnitSO, AvailableCommands)

**해결:**
- ✅ Layer: 0 → 6 (Selectable Units)
- ✅ DecalProjector GameObject 추가 (Transform + DecalProjector 컴포넌트)
- ✅ decalProjector 필드 참조 연결
- ✅ UnitSO: Worker SO 참조 추가 (GUID: `f15d9d4a0e8b3d848a49aaba59177157`)
- ✅ AvailableCommands: Move Action 추가 (GUID: `5b88f1c2df63cea41a0b8cd466334886`)
- ✅ DecalProjector Material 설정 (Selected Ring Decal Material, GUID: `949870381fdaf4941aedc8857fe165e9`)

**파일:** `Assets/Units/Worker/MarineThreeRobot.prefab`

---

### 2. ThreePartRobotBuilder 업데이트 (완전한 프리팹 자동 생성)

**업데이트 내용:**
```csharp
// 자동 설정 항목
robot.layer = 6; // Selectable Units

// DecalProjector GameObject 자동 생성
GameObject decalProjector = new GameObject("Decal Projector");
decalProjector.SetActive(false);
var projector = decalProjector.AddComponent<DecalProjector>();
projector.material = LoadMaterial("Selected Ring Decal Material");
projector.size = new Vector3(1.5f, 1.5f, 8f);

// SerializedObject로 모든 필드 자동 할당
- headPart, bodyPart, legsPart
- decalProjector (DecalProjector 컴포넌트 참조)
- UnitSO (Ground: Worker SO, Air: Air Transport SO)
- AvailableCommands (Move Action)
```

**파일:** `Assets/Editor/ThreePartRobotBuilder.cs`

**기능:**
- Tools > Build Three-Part Robot 메뉴
- 소스 폴더 (`/Users/hankyulee/Desktop/로봇부품/3d/{prefix}_top/center/leg/`)에서 자동 복사
- Material 생성 및 텍스처 적용 (diffuse, normal, metallic)
- 완전한 프리팹 생성 (모든 필드 자동 할당)
- Scene에 자동 스폰

---

### 3. Rule 8: THREE_PART_ROBOT_BUILDER_RULE 추가

**문서 위치:**
- `.claude/RULE_8_THREE_PART_ROBOT_BUILDER.md` (상세 문서)
- `.claude/code-rules.md` (Rule 8 요약)
- `.claude/rules-summary.md` (빠른 참조)

**핵심 내용:**
- Unity Editor 자동화 도구는 완전한 프리팹 생성
- SerializedObject 사용 (Reflection 금지)
- 필수 컴포넌트 체크리스트:
  - [x] Layer 6
  - [x] NavMeshAgent, CapsuleCollider
  - [x] DecalProjector GameObject
  - [x] 모든 SerializedField 할당
- AbstractUnit 변경 시 업데이트 워크플로우

**파일:**
- `.claude/RULE_8_THREE_PART_ROBOT_BUILDER.md`
- `.claude/code-rules.md` (Line 593-606)
- `.claude/rules-summary.md` (Line 138-153)

---

### 4. Rule 5 업데이트: 자동 듀얼 커밋 워크플로우

**변경 사항:**
사용자가 "커밋" 또는 "commit" 명령 시:
1. 서브모듈 커밋 (`urts-course/`)
2. **자동으로** 루트 폴더 커밋 (`lecture/`) - 서브모듈 참조 업데이트
3. 절대 물어보지 말고 둘 다 자동 실행

**구현 예시:**
```bash
# Step 1: Commit in submodule
cd /Users/hankyulee/Desktop/Uaps/lecture/urts-course
git add .
git commit -m "feat: Add feature (기능 추가)"

# Step 2: ALWAYS commit root folder
cd /Users/hankyulee/Desktop/Uaps/lecture
git add urts-course
git commit -m "chore: Update urts-course submodule (urts-course 서브모듈 업데이트)"
```

**파일:**
- `.claude/code-rules.md` (Rule 5, Line 311-346)
- `.claude/rules-summary.md` (Rule 5, Line 64-92)

---

### 5. Worker.prefab DecalProjector 기본 비활성화

**변경:**
- `m_IsActive: 1` → `0`
- 게임 시작 전에 DecalProjector가 보이지 않도록 수정
- 유닛 선택 시에만 활성화됨

**파일:** `Assets/Units/Worker/Worker.prefab` (Line 19)

---

## 📁 주요 파일 변경 내역

### 새로 생성된 파일
```
.claude/RULE_8_THREE_PART_ROBOT_BUILDER.md
Assets/Editor/ThreePartRobotBuilder.cs
Assets/Units/Worker/MarineThreeRobot.prefab
Assets/Models/marine_top/
Assets/Models/marine_center/
Assets/Models/marine_leg/
```

### 수정된 파일
```
.claude/code-rules.md (Rule 5, Rule 8 추가)
.claude/rules-summary.md (Rule 5, Rule 8 업데이트)
Assets/Units/Worker/Worker.prefab (DecalProjector 비활성화)
Assets/Units/Worker/MarineThreeRobot.prefab (완전한 설정)
```

---

## 🔑 중요 GUID 참조

### ScriptableObjects
- **Worker SO**: `f15d9d4a0e8b3d848a49aaba59177157`
- **Air Transport SO**: `f6b38bef630bb884195c6d3f702eefb9`
- **Move Action**: `5b88f1c2df63cea41a0b8cd466334886`

### Materials
- **Selected Ring Decal Material**: `949870381fdaf4941aedc8857fe165e9`

### Scripts
- **WorkerThreeRobot**: `b7a69ec278a4949f09913fd8f726e469`
- **DecalProjector**: `0777d029ed3dffa4692f417d4aba19ca`

---

## 📊 Git 커밋 이력

### 서브모듈 (urts-course)
```
cade4a1 - feat: Add ThreePartRobotBuilder automation tool and Rule 8
a0410a1 - docs: Update Rule 5 with automatic dual commit workflow
```

### 루트 폴더 (lecture)
```
968d7ca - chore: Update urts-course submodule
```

---

## 🎯 현재 프로젝트 상태

**강의:**
- 총 15개 완료 (11-12시간)
- 최근 강의: Deselecting Units with Event Bus

**Tools:**
- ThreePartRobotBuilder: 3-파트 로봇 자동 생성 툴

**현재 브랜치:**
- urts-course: `dev`
- lecture: `main`

**3-Part 로봇:**
- WorkerThreeRobot.prefab ✅
- AirTransportThreeRobot.prefab ✅
- MarineThreeRobot.prefab ✅ (이번 세션에서 수정 완료)

---

## 🚀 다음 세션에서 할 일

### 1. ThreePartRobotBuilder 테스트
새로운 로봇 타입 (예: Sniper, Tank 등)을 Tools > Build Three-Part Robot으로 생성해서 모든 필드가 제대로 할당되는지 확인

### 2. 기존 프리팹 검증
- AirTransportThreeRobot.prefab
- WorkerThreeRobot.prefab

위 프리팹들도 모든 필드가 제대로 할당되어 있는지 재확인

### 3. AbstractUnit/AbstractCommandable 변경 시 대응
만약 새로운 필드가 추가되면:
1. ThreePartRobotBuilder.cs 업데이트
2. 기존 프리팹들 수정
3. Rule 8 문서 업데이트

---

## 📝 기술 노트

### SerializedObject vs Reflection

**❌ Reflection (작동 안함):**
```csharp
var field = scriptType.GetField("headPart", BindingFlags.NonPublic);
field?.SetValue(script, headPart);
```

**✅ SerializedObject (Unity 정식 방법):**
```csharp
SerializedObject serializedScript = new SerializedObject(script);
SerializedProperty headProperty = serializedScript.FindProperty("headPart");
headProperty.objectReferenceValue = headPart;
serializedScript.ApplyModifiedProperties();
```

### Auto-Property 네이밍
C# auto-property는 Unity에서 백킹 필드 이름이 변경됨:
```csharp
[field: SerializeField] public ActionBase[] AvailableCommands { get; private set; }
```
→ SerializedProperty 이름: `<AvailableCommands>k__BackingField`

---

## 🔍 디버깅 팁

### 유닛이 선택되지 않을 때 체크리스트
1. Layer가 6 (Selectable Units)인가?
2. DecalProjector GameObject가 자식으로 있는가?
3. decalProjector 필드가 null이 아닌가?
4. UnitSO가 할당되어 있는가?
5. AvailableCommands 배열에 Move Action이 있는가?

### DecalProjector가 안 보일 때
1. Material이 null이 아닌가? (`m_Material: {fileID: 2100000, guid: 949870...}`)
2. m_IsActive가 0인가? (게임 시작 전에는 꺼져있어야 함)
3. DecalLayerMask가 2인가?
4. Size와 Pivot이 올바른가? (Size: 1.5, 1.5, 8 / Pivot: 0, 0, 4)

---

## 📚 관련 문서

- **Rule 8**: `.claude/RULE_8_THREE_PART_ROBOT_BUILDER.md`
- **Rule 5**: `.claude/code-rules.md` (Line 246-351)
- **Rules Summary**: `.claude/rules-summary.md`
- **Architecture**: `/Users/hankyulee/Desktop/Uaps/lecture/urts-scripts-architecture.html`

---

## 💡 주요 학습 포인트

1. **Unity Editor Scripting은 SerializedObject 사용**
   - Reflection은 Unity Editor에서 신뢰성이 낮음
   - SerializedProperty로 필드 할당이 정석

2. **Layer 6은 유닛 선택의 핵심**
   - PlayerInput에서 Raycast할 때 Layer 6만 감지
   - Layer 0이면 선택 불가

3. **DecalProjector는 별도 GameObject**
   - 단순 컴포넌트가 아닌 자식 GameObject로 추가
   - Transform 설정 필수 (Rotation: 90, 0, 0)

4. **자동화 도구는 완전한 프리팹 생성**
   - 수동 수정이 필요하면 자동화 실패
   - Rule 8을 따라 모든 필드 자동 할당

5. **듀얼 커밋 필수**
   - 서브모듈만 커밋하면 루트 폴더에 반영 안됨
   - 항상 서브모듈 → 루트 순서로 커밋

---

**작성일**: 2025-10-10
**작성자**: Claude Code
**다음 세션 시작 시**: `인수인계` 명령어 또는 `/handoff` 슬래시 커맨드 실행
